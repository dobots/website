<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Distributed Organisms B.V., shorthand DoBots, specializes in Smart Robots and Smart Buildings. DoBots implements localization, mapping, and navigation algorithms on robots and indoor localization, automation, and tracking algorithms in buildings.">
<meta name="author" content="Distributed Organisms B.V.">
<link rel="icon" type="image/x-icon" href="/images/favicon.ico?">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">


<title>DoBots | Programming the nRF51822 with the ST-link</title>


<meta name="description" content="The ST-Link is incorporated in cheap boards (STM32F boards) and can be used to program the nRF51822">

<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<link rel="stylesheet" type="text/css" href="/assets/elusive-webfont-b4b08c54aa385fbc9433a5864604eb0a37430d49016644f6c2225b9c9f6528d4.css">

<!-- Custom styles for this template -->

<link rel="stylesheet" type="text/css" href="/assets/flexslider-af37d743866caa19c33f16fdb8585f2b6331c7b25bfcb9b0b2fd4720d61df9b5.css">
<link rel="stylesheet" type="text/css" href="/assets/dobots-style-6a93bbafd311befa179f35a7f457349cb1b7ed24686877defdb4530f84dcc1fe.css">

<!--[if lt IE 9]>
	<script src="/assets/themes//resources/respond/Respond.min.js"></script>
<![endif]-->

<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


</head>

<body>
    <!--
<div id="headerBar" onclick="location.href='http://crownstone.rocks';">
<center>
<h4>
<a href="http://crownstone.rocks/">http://crownstone.rocks</a> power outlet!
</h4>
</center>
</div>
    -->
<header id="header" class="mini-wrap">
	<div class="navbar navbar-inverse" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/"><img src="/images/logo.png" class="img-responsive" alt="DoBots"></a>
			</div>

			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav navbar-right main-nav">
					
					
					


  
    
      
    
  
    
      
      	
      	<li><a href="/applications/cleaning/">Applications</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/products/autopilot/">Technology</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/jobs/">Jobs</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/blog/">Blog</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/about-us/">About</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/search/">Search</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
	<li><a href="mailto:info@dobots.nl?subject=Get%20in%20contact">Contact</a></li>




				</ul>
			</div>
		</div>
	</div>
</header>

<section id="sub-menu" class="mini-wrap">
	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<ul class="list-unstyled sub-menu pull-left slogan">
					<!--					<li>"Computers, come, join us in the real world!"</li> -->
					<li>
<a href="/2014/05/23/best-european-startup/">Best European Startup Award</a> winner of <a href="http://robotlaunch.com/">Robot Launch</a>!
					</li>
				</ul>
                <!--
				<ul class="list-unstyled sub-menu pull-right">
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
						
					
					
						
						
							
							
							
							
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
						
					
				</ul>
                -->
			</div>
		</div>
	</div>
</section> <!--end / sub-menu-->


<!--
<div class="page-header">
  <h1>Programming the nRF51822 with the ST-link </h1>
</div>
-->

<div class="container">
	<div class="row post-full">
		<div class="col-md-12">
			<div class="date">
				<strong class="date_month">Jan</strong>
				<strong class="date_day">23</strong>
				<strong class="date_year">2015</strong>
				<!--      <span>23 January 2015</span> -->
			</div>
			
			
			<div class="author-block">
				
				<img src="https://secure.gravatar.com/avatar/818dc2df03cd2f1ca7d6e6e701052f0c?s=40">
				
				<span class="author">Anne van Rossum</span>
			</div>
			
			<div class="post">
				<div class="content">
					
<h1 id="segger-connector">Segger connector</h1>

<p>If your device has a connector that is meant for The Segger JLink programmer, you can find the pin layout at
<a href="https://www.segger.com/jlink-adapters.html#CM_9pin">https://www.segger.com/jlink-adapters.html#CM_9pin</a>. The default programmer with the Nordic development kit comes with
the J-Link 9-pin Cortex-M adapter.</p>

<p>The ones that you will need to break out are four wires that at the top:</p>

<pre><code>1. VTref
2. SWDIO
3. GND
4. SWCLK
</code></pre>

<p>The first one is optional! It does not provide power, it is used to <strong>measure</strong> if the target board does have power.</p>

<h1 id="st-link-programmer">ST-Link programmer</h1>

<p>The ST-Link programmer is not easy obtainable, just as the J-Link programmer is actually hard to come by as a separate
product.</p>

<p>For that reason it is worth to check into the STM32FDISCOVERY board. You can get the <a href="http://no.mouser.com/ProductDetail/STMicroelectronics/STM32F4DISCOVERY/?qs=J2qbEwLrpCGdWLY96ibNeQ%3D%3D">STM32FDISCOVERY at Mouser</a> for € 13,47. This board is anyway fun, it has a
lot of GPIO (pins) and it has an ST-Link on-board.</p>

<p><img src="/attachments/stm32f4_discovery.jpg" alt="STM32F Discovery Board" title="STM32F Discovery Board"></p>

<p>On the STM32 board you see a connector with the label <code>SWD</code>. We need to pins from there. From the top (where there is
the USB connection), we need the second pin and connect it to <code>SWCLK</code>. From the top we need also the fourth pin, and
connect it to <code>SWDIO</code>.</p>

<p>The Crownstone (or RFduino, or any other nRF51822 board) needs then also to be powered and grounded. The power can be
fed to the device also from the STM32 board. You can connect one of the pins labeled <code>3V</code> on the right of the board
to the corresponding pin on your device. Ground can be obtained from many pins, pick one labeled <code>GND</code>. The VTref pin
from the J-Link does not have a corresponding VTref pin on the ST-Link. On the STM32FDiscovery board probably 
somewhere internally the reference voltage is measured. So, you’ll only have to break out three pins of the cable to
connect it:</p>

<pre><code>2. SWDIO
3. GND
4. SWCLK
</code></pre>

<p>Use something like a logic analyzer to see if you do things wrong. This is a very, very useful tool that can save you
a lot of time.</p>

<h1 id="scripts">Scripts</h1>

<p>Normally the Crownstone we program with the J-Link from Segger, but if you want to use this cheaper solution, we also
created some files for you at the <a href="https://github.com/dobots/bluenet/tree/master/scripts">BlueNet repository at github</a>.</p>

<h2 id="combination">Combination</h2>

<p>First of all you can combine all the required binaries into one big binary. This is done by the script <code>combine.sh</code>.
Before you use it, you will need to install <code>srec_cat</code> on your system. On Ubuntu:</p>

<pre><code>sudo apt-get install srecord
</code></pre>

<p>If you call the script it basically just runs <code>srec_cat</code>:</p>

<pre><code>./combine.sh
</code></pre>

<p>And you will see that it runs something like if you only want the SoftDevice and the Crownstone for example:</p>

<pre><code>srec_cat /opt/softdevices/s110_nrf51822_7.0.0_softdevice.hex -intel crownstone.bin -binary -offset 0x00016000 -o combined.bin
</code></pre>

<p>You have to adjust that file on the moment manually to switch between softdevices.</p>

<h2 id="openocd">OpenOCD</h2>

<p>Subsequently, we are gonna set up OpenOCD. You should <strong>not</strong> use the one from the Ubuntu repository: it is too old. In case you installed it before:</p>

<pre><code> sudo apt-get remove --purge openocd
</code></pre>

<p>Download fom github and compile the source:</p>

<pre><code>cd /opt
git clone https://github.com/ntfreak/openocd
sudo aptitude install libtool automake libusb-1.0-0-dev expect
cd openocd
./bootstrap 
./configure --enable-stlink
make
sudo make install
</code></pre>

<p>You will see that there are several files on <a href="https://github.com/dobots/bluenet/tree/master/scripts/openocd">github</a> 
that you can use. There is a <code>49-stlinkv2.rules</code> file that you can use for <code>udev</code> so that no superuser rights are 
required to use the <code>ST-Link</code>. There is also an <code>openocd.cfg</code> file that sets the defaults for the hardware we are
gonna use (the <code>nrf51</code> series).</p>

<p>To start OpenOCD you can use our scripts again:</p>

<pre><code>./flash_openocd.sh init
</code></pre>

<p>This will start the daemon that subsequently can be talked to over telnet. You can try that if you want to (but this
is not necessary):</p>

<pre><code>./flash_openocd.sh connect
&gt; help
&gt; exit
</code></pre>

<p>To actually upload the binaries you have created, you can use:</p>

<pre><code>./flash_openocd.sh upload combined.hex
</code></pre>

<p>This will upload the binary you have previously composed to the target. Ready you are!</p>

<h2 id="debugging">Debugging</h2>

<p>If your target does not have pins to break out UART, it might be worth to first try and start experimenting with the
RFduino. That board has enough pins broken out, to see what for example the Crownstone code is actually doing. For
example if you combine a SoftDevice with the wrong bootloader, you will see proper error messages. If you know how
to hook up <code>gdb</code> over OpenOCD, please feel free to file an issue at <a href="https://github.com/dobots/bluenet/">https://github.com/dobots/bluenet/</a> and I will
be happy to update this guide.</p>


				</div>

				

				
				<div class="tag_box inline">
					<i class="icon-tags"></i>

					
					


  
     
    	<a href="/tags.html#nrf51822-ref">nrf51822</a> 
     
    	<a href="/tags.html#ble-ref">ble</a> 
    
  




				</div>
				
				<hr>

				<div class="social-button-footer">
					<p>
					<a class="btn btn-social-icon btn-twitter" href="http://twitter.com/intent/tweet?url=https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link&amp;text=Programming%20the%20nRF51822%20with%20the%20ST-link"><i class="icon-twitter"></i></a>
					<a class="btn btn-social-icon btn-facebook" href="http://facebook.com/sharer.php?u=https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link"><i class="icon-facebook"></i></a>
					<a class="btn btn-social-icon btn-googleplus" href="https://plus.google.com/share?url=https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link"><i class="icon-googleplus"></i></a>
					<a class="btn btn-social-icon btn-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link"><i class="icon-linkedin"></i></a>
					<a class="btn btn-social-icon btn-reddit" href="http://reddit.com/submit?url=https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link&amp;title=Programming%20the%20nRF51822%20with%20the%20ST-link"><i class="icon-reddit"></i></a>
					</p>
				</div>


				<ul class="pagination">
					
					<li class="prev"><a href="/2014/11/28/feltyou-prototype" title="FeltYou prototype">← Previous</a></li>
					
					<li><a href="/blog">Archive</a></li>
					
					<li class="next"><a href="/2015/02/05/rplidar-with-rtabmap-on-turtlebotmd" title="RPlidar vs kinect's laserscan with RTabmap on turtlebot">Next →</a></li>
					
				</ul>
				<hr>
				


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dobots'; 
    
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




			</div>
		</div>
	</div>



<footer id="footer" class="mini-wrap gray">
	<div class="container">
		<div class="row">
			<div class="col-xs-6 col-sm-6 col-md-6 more-padding">
				<img src="/images/youtube.png" alt="youtube"> Watch our <a href="https://www.youtube.com/channel/UC7bsuzp2BfL5F5RX07oLIzw">movies</a> and follow us on <a href="http://facebook.com/dobots">Facebook!</a>
</div>
			<div class="col-xs-6 col-sm-6 col-md-6">
				<ul class="list-items pull-right gutter-top-btm">
					<li><a href="index.html">
						<img src="/images/footer-logo.png" class="img-responsive" alt="DoBots"></a></li>
					<li class="robot-info-dilog">
<a href="#">
						<img src="/images/two-robot.png" width="103" height="85" alt="robot">
					</a>
					<div class="footer-robot-dilog">
						<div class="inner-robot-dilog">
							Do you have a question? <script type="text/javascript">/*<![CDATA[*/var a=new Array(".nl","bots","do","@","fo","in");document.write("<a href='mailto:");for(i=a.length-1;i>=0;i--){document.write(a[i])}document.write("?subject=DoBots Contact' class='btn btn-default'>Yes</a>");/*]]>*/</script>
							<div class="inner-arrow-right">
								<img alt="dilog" class="img-responsive" src="/images/inner-dilog.png" draggable="false"> </div>
						</div>

					</div>
					</li>
				</ul>

			</div>
		</div>
	</div>
</footer>




  <script type="text/javascript">
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-17146802-10', 'auto');
ga('send', 'pageview');
</script>
<script type="text/javascript" async src="https://www.google-analytics.com/analytics.js"></script>






<!-- in debug mode, Google Chrome worries about .map files, do not worry -->


<script type="text/javascript" src="/assets/jquery.min-7f30f220312176c728c3bb41a567ccc2e1ce2e7a8dd7c9cefd59fe197ba047b2.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script type="text/javascript" src="/assets/jquery.flexslider-122776e067a7b77f685ce8fbbd3cb75136ce8ca23f243a50de28c1545ec6bb68.js"></script>

<script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/javascript">
$(window).load(function(){
		$('.text-slider').flexslider({
			animation: "slide",
			start: function(slider){
				$('body').removeClass('loading');
			}
		});
	});
</script>

</div>
</body>
</html>
